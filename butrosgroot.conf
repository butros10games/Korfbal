# upstream component nginx needs to connect to
upstream butros10games {
    server 192.168.2.88:1664;
}

upstream simracing-prod {
    server 192.168.2.90:1664;
}

upstream butrosgroot {
    server 192.168.2.155:1664;
}

upstream korfbal {
    server 192.168.2.8:1664;
}

upstream skinscentre {
    server 192.168.2.73:1664;
}

# WebSocket upstream for both domains
upstream websocket_backend_butros10games {
    server 192.168.2.88:8001;
}

# WebSocket upstream for both domains
upstream websocket_backend_simracing-prod {
    server 192.168.2.90:8001;
}

# WebSocket upstream for both domains
upstream websocket_backend_butrosgroot {
    server 192.168.2.155:8001;
}

# WebSocket upstream for both domains
upstream websocket_backend_korfbal {
    server 192.168.2.8:8001;
}

upstream websocket_backend_skinscentre {
    server 192.168.2.73:8001;
}

# configuration of the server
server {
    server_name butros10games.nl www.butros10games.nl;

    # max upload size
    keepalive_timeout 5;
    client_max_body_size 4G;
    
    access_log /home/butros/logs/nginx-access.log;
    error_log /home/butros/logs/nginx-error.log;

    # SSL configuration
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/butros10games.nl-0001/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/butros10games.nl-0001/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Django media and static files for butros10games.nl
    location /media  {
        alias /mnt/nfs/simracing/media;
    }

    location /static {
        alias /mnt/nfs/simracing/static;
    }

    # Send all non-media requests to the Django server for butros10games.nl.
    location / {
        proxy_pass http://butros10games/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # For butros10games.nl
    location /static/js/service-worker.js {
	proxy_pass http://butros10games/static/js/service-worker.js;
	add_header 'Service-Worker-allowed' '/';
    }

    # WebSocket support for butros10games.nl
    location /ws/ {
        try_files $uri @proxy_to_ws_butros10games;
    }

    location @proxy_to_ws_butros10games {
        proxy_pass http://websocket_backend_butros10games;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }
}

server {
    server_name simracing-centre.net www.simracing-centre.net;

    # max upload size
    keepalive_timeout 5;
    client_max_body_size 4G;

    access_log /home/butros/logs/nginx-access.log;
    error_log /home/butros/logs/nginx-error.log;

    # SSL configuration
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/butros10games.nl-0001/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/butros10games.nl-0001/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Django media and static files for butros10games.nl
    location /media  {
        alias /mnt/nfs/simracing/media;
    }

    location /static {
        alias /mnt/nfs/simracing/static;
    }

    # Send all non-media requests to the Django server for butros10games.nl.
    location / {
        proxy_pass http://simracing-prod/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # For butros10games.nl
    location /static/js/service-worker.js {
        proxy_pass http://simracing-prod/static/js/service-worker.js;
        add_header 'Service-Worker-allowed' '/';
    }

    # WebSocket support for butros10games.nl
    location /ws/ {
        try_files $uri @proxy_to_ws_simracing-prod;
    }

    location @proxy_to_ws_simracing-prod {
        proxy_pass http://websocket_backend_simracing-prod;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }
}

server {
    server_name butrosgroot.com www.butrosgroot.com;

    # max upload size
    keepalive_timeout 5;
    client_max_body_size 4G;

    access_log /home/butros/logs/nginx-access.log;
    error_log /home/butros/logs/nginx-error.log;

    # SSL configuration
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/butrosgroot.com-0001/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/butrosgroot.com-0001/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Django media and static files for butrosgroot.com
    location /media  {
        alias /mnt/nfs/butrosgroot/media;
    }

    location /static {
        alias /mnt/nfs/butrosgroot/static;
    }

    # Send all non-media requests to the Django server for butrosgroot.com.
    location / {
        proxy_pass http://butrosgroot/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # For butrosgroot.com
    location /static/js/service-worker.js {
	proxy_pass http://butrosgroot/static/js/service-worker.js;
	add_header 'Service-Worker-allowed' '/';
    }

    # WebSocket support for butrosgroot
    location /ws/ {
        try_files $uri @proxy_to_ws_butrosgroot;
    }

    location @proxy_to_ws_butrosgroot {
        proxy_pass http://websocket_backend_butrosgroot;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }
}

server {
    server_name korfbal.butrosgroot.com;

    # max upload size
    keepalive_timeout 5;
    client_max_body_size 4G;

    access_log /home/butros/logs/nginx-access.log;
    error_log /home/butros/logs/nginx-error.log;

    # SSL configuration
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/korfbal.butrosgroot.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/korfbal.butrosgroot.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Django media and static files for korfbal
    location /media  {
        alias /mnt/nfs/Korfbal/media;
    }

    location /static {
        alias /mnt/nfs/Korfbal/static;
    }

    # Send all non-media requests to the Django server for korfbal.
    location / {
        proxy_pass http://korfbal/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # For korfbal
    location /static/js/service-worker.js {
        proxy_pass http://korfbal/static/js/service-worker.js;
        add_header 'Service-Worker-allowed' '/';
    }

    # WebSocket support for korfbal
    location /ws/ {
        try_files $uri @proxy_to_ws_korfbal;
    }

    location @proxy_to_ws_korfbal {
        proxy_pass http://websocket_backend_korfbal;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }
}

server {
    server_name skinscentre.com www.skinscentre.com;

    # max upload size
    keepalive_timeout 5;
    client_max_body_size 4G;

    access_log /home/butros/logs/nginx-access.log;
    error_log /home/butros/logs/nginx-error.log;

    # SSL configuration
    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/skinscentre.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/skinscentre.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Django media and static files for korfbal
    location /media  {
        alias /mnt/nfs/skinscentre/media;
    }

    location /static {
        alias /mnt/nfs/skinscentre/static;
    }

    # Send all non-media requests to the Django server for skinscentre.
    location / {
        proxy_pass http://skinscentre/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # For skinscentre
    location /static/js/service-worker.js {
        proxy_pass http://skinscentre/static/js/service-worker.js;
        add_header 'Service-Worker-allowed' '/';
    }

    # WebSocket support for skinscentre
    location /ws/ {
        try_files $uri @proxy_to_ws_skinscentre;
    }

    location @proxy_to_ws_skinscentre {
        proxy_pass http://websocket_backend_skinscentre;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $server_name;
    }
}


# HTTP to HTTPS redirect
server {
    server_name butros10games.nl www.butros10games.nl butrosgroot.com www.butrosgroot.com simracing-centre.net www.simracing-centre.net korfbal.butrosgroot.com skinscentre.com www.skinscentre.com;

    listen 80;
    return 301 https://$host$request_uri;
}

